#!/usr/bin/env node

var _ = require("lodash");
var crypto = require("crypto");
var fs = require("fs");
var gpml2pvjson = require("../lib/GPML2013aToPVJSON").GPML2013aToPVJSON;
var hl = require("highland");
var npmPackage = JSON.parse(
  fs.readFileSync("./package.json", { encoding: "utf8" })
);
var ndjson = require("ndjson");
var program = require("commander");
var VError = require("verror");

program
  .version(npmPackage.version)
  .description("Converts GPML (XML) to pvjson (JSON)")
  .option(
    "--id [string]",
    'Specify unique ID of this pathway, e.g., "http://identifiers.org/wikipathways/WP4"'
  );

program.on("--help", function() {
  console.log("  Examples:");
  console.log();
  console.log("    Display pvjson in command line:");
  console.log(
    `    $ gpml2pvjson --id http://identifiers.org/wikipathways/WP554 < ./test/input/WP554_77712.gpml`
  );

  console.log("    Save pvjson to new file:");
  console.log(
    "    $ gpml2pvjson < ./test/input/WP554_77712.gpml > ./WP554_77712.json"
  );

  console.log("    Download from WikiPathways and convert:");
  console.log(
    `    $ curl "http://webservice.wikipathways.org/getPathwayAs?fileType=xml&pwId=WP554&revision=77712&format=xml" | xpath "*/ns1:data/text()" | base64 --decode | gpml2pvjson --id http://identifiers.org/wikipathways/WP554`
  );

  console.log("    Get w/ WikiPathways API and convert:");
  console.log(
    `    $ wikipathways-api-client get-pathway WP4 | gpml2pvjson --id http://identifiers.org/wikipathways/WP4`
  );
});

program.parse(process.argv);

var id = program.id;
// NOTE If an id is not provided, the CLI generates a hash of the input to use as the id. See
// https://bentrask.com/?q=hash://sha256/98493caa8b37eaa26343bbf73f232597a3ccda20498563327a4c3713821df892
// This is for the CLI only; the library itself does not do this.
var HASH_NAME = "sha256";

var gpmlSeparator = '<?xml version="1.0" encoding="UTF-8"?>';

//var source = hl(process.stdin).splitBy(gpmlSeparator).intersperse(gpmlSeparator);
var source = hl(process.stdin).splitBy(gpmlSeparator).drop(1);
/*
var source = id
  ? process.stdin
  : hl(process.stdin).doto(function(chunk) {
      hash.update(chunk);
    });
//*/

/*
hl(source).map(gpml => hl([gpml])).each(function(gpmlStream) {
  const gpmlStreamFork = gpmlStream.fork();
  const gpmlStreamLast = gpmlStream.fork().last();
  gpmlStreamLast.each(function(gpml) {
    console.log("lastgpml");
    console.log(gpml);
  });
  gpmlStreamFork.each(function(gpml) {
    console.log("gpmlStream");
    console.log(gpmlStream);
    console.log("gpml");
    console.log(gpml);
  });
  gpmlStream.end();
});
//*/

//*
hl(source).map(gpml => hl([gpml])).each(function(gpmlStream) {
  const hash = crypto.createHash(HASH_NAME);
  hash.setEncoding("hex");

  gpmlStream.observe().doto(chunk => hash.update(chunk.toString()));

  gpml2pvjson(gpmlStream, id)
    .last()
    //*
    .map(function(pvjson) {
      if (!pvjson.pathway.id) {
        pvjson.pathway.id = `hash://${HASH_NAME}/${hash.digest("hex")}`;
      }
      return pvjson;
    })
    //*/
    .errors(function(err) {
      console.error(err);
      process.exit(1);
    })
    .pipe(ndjson.serialize())
    .pipe(process.stdout);
});
//*/

// TODO does the process exit on its own?
//process.exit(0);

/*
rebuild and run like this:
npm run compile:es5 && bin/gpml2pvjson --id http://identifiers.org/wikipathways/WP554 < ./test/input/WP554_77712.gpml

currently need to run commands like this:
../wikipathways-api-client-js/bin/wikipathways-api-client get-pathway WP4 | bin/gpml2pvjson --id http://identifiers.org/wikipathways/WP4

cat test/input/WP554_77712.gpml | bin/gpml2pvjson --id http://identifiers.org/wikipathways/WP554

for f in playground/wikipathways-20170510-gpml-Homo_sapiens/*.gpml; do cat "$f" | bin/gpml2pvjson --id "http://identifiers.org/wikipathways/"`echo "$f" | sed 's/.*_WP/WP/' | sed 's/_.*.gpml//'`; done

for f in playground/wikipathways-20170510-gpml-Homo_sapiens/*.gpml; do WPID=`echo "$f" | sed 's/.*_WP/WP/' | sed 's/_.*.gpml//'`; cat "$f" | bin/gpml2pvjson --id "http://identifiers.org/wikipathways/"$WPID > ./playground/pvjson/$WPID.json; done

for f in playground/wikipathways-20170510-gpml-Homo_sapiens/*.gpml; do echo && echo "$f" && WPID=`echo "$f" | sed 's/.*_WP/WP/' | sed 's/_.*.gpml//'`; cat "$f" | bin/gpml2pvjson --id "http://identifiers.org/wikipathways/"$WPID; done

for f in ../pvjs/test/input-data/troublesome-pathways/*.gpml; do echo && echo "$f" && WPID=`echo "$f" | sed 's/.*_WP/WP/' | sed 's/_.*.gpml//'`; cat "$f" | bin/gpml2pvjson --id "http://identifiers.org/wikipathways/"$WPID; done

//*/

/*
// These aren't fully working yet:
../wikipathways-api-client-js/bin/wikipathways-api-client list | while read i; do echo "$i"; sleep 0.01; done | jq '.identifier' | ../wikipathways-api-client-js/bin/wikipathways-api-client get-pathway | bin/gpml2pvjson

../wikipathways-api-client-js/bin/wikipathways-api-client list | head | while read i; do echo "$i"; sleep 0.01; done | jq '.identifier' | ../wikipathways-api-client-js/bin/wikipathways-api-client get-pathway | bin/gpml2pvjson

../wikipathways-api-client-js/bin/wikipathways-api-client list | while read i; do echo "$i"; sleep 0.01; done | head | jq '.identifier' | ../wikipathways-api-client-js/bin/wikipathways-api-client get-pathway | bin/gpml2pvjson
//*/
